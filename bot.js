const Discord = require('discord.js');
const client = new Discord.Client();
const ytdl = require('ytdl-core');
const request = require('request');
const fs = require('fs');
const getYoutubeID = require('get-youtube-id');
const fetchVideoInfo = require('youtube-info');

const yt_api_key = "AIzaSyDeoIH0u1e72AtfpwSKKOSy3IPp2UHzqi4";
const prefix = '$';

client.on('ready', () => {
  console.log(`Logged in as ${client.user.tag}!`);
client.user.setGame(`$play`,"https://www.twitch.tv/Anime & Games")
  console.log('')
  console.log('')
  console.log('â•”[â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]â•—')
  console.log(`[Start] ${new Date()}`);
  console.log('â•š[â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]â•')
  console.log('')
  console.log('â•”[â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]â•—');
  console.log(`Logged in as * [ " ${client.user.username} " ]`);
  console.log('')
  console.log('Informations :')
  console.log('')
  console.log(`servers! [ " ${client.guilds.size} " ]`);
  console.log(`Users! [ " ${client.users.size} " ]`);
  console.log(`channels! [ " ${client.channels.size} " ]`);
  console.log('â•š[â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•]â•')
  console.log('')
  console.log('â•”[â•â•â•â•â•â•â•â•â•â•â•â•]â•—')
  console.log(' Bot Is Online')
  console.log('â•š[â•â•â•â•â•â•â•â•â•â•â•â•]â•')
  console.log('')
  console.log('')
});









/*
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
////////////////////////\\\\\\\\\\\\\\\\\\\\\\\\\
*/
var servers = [];
var queue = [];
var guilds = [];
var queueNames = [];
var isPlaying = false;
var dispatcher = null;
var voiceChannel = null;
var skipReq = 0;
var skippers = [];
var now_playing = [];
/*
\\\\\\\\\\\\\\\\\\\\\\\\/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\/////////////////////////
\\\\\\\\\\\\\\\\\\\\\\\\/////////////////////////
*/
client.on('ready', () => {});
console.log("Logged")
var download = function(uri, filename, callback) {
	request.head(uri, function(err, res, body) {
		console.log('content-type:', res.headers['content-type']);
		console.log('content-length:', res.headers['content-length']);

		request(uri).pipe(fs.createWriteStream(filename)).on('close', callback);
	});
};

client.on('message', function(message) {
	const member = message.member;
	const mess = message.content.toLowerCase();
	const args = message.content.split(' ').slice(1).join(' ');

	if (mess.startsWith(prefix + 'play')) {
		if (!message.member.voiceChannel) return message.reply('** Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ **');
		// if user is not insert the URL or song title
		if (args.length == 0) {
			let play_info = new Discord.RichEmbed()
				.setAuthor(client.user.username, client.user.avatarURL)
				.setDescription('**Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ÙˆØ¶Ø¹ Ø§Ø³Ù… Ø§ØºÙ†ÙŠÙ‡ Ø§Ùˆ Ø±Ø§Ø¨Ø· Ø§ØºÙ†ÙŠÙ‡**')
			message.channel.sendEmbed(play_info)
			return;
		}
		if (queue.length > 0 || isPlaying) {
			getID(args, function(id) {
				add_to_queue(id);
				fetchVideoInfo(id, function(err, videoInfo) {
					if (err) throw new Error(err);
					let play_info = new Discord.RichEmbed()
						.setAuthor("ØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ù‚Ø§Ø¦Ù…Ù‡ ", message.author.avatarURL)
						.setDescription(`**${videoInfo.title}**`)
						.setColor("RANDOM")
						.setFooter('ØªÙ… ØªØ´ØºÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ù‡:' + message.author.tag)
						.setImage(videoInfo.thumbnailUrl)
					//.setDescription('?')
					message.channel.sendEmbed(play_info);
					queueNames.push(videoInfo.title);
					// let now_playing = videoInfo.title;
					now_playing.push(videoInfo.title);

				});
			});
		}
		else {

			isPlaying = true;
			getID(args, function(id) {
				queue.push('placeholder');
				playMusic(id, message);
				fetchVideoInfo(id, function(err, videoInfo) {
					if (err) throw new Error(err);
					let play_info = new Discord.RichEmbed()
						.setAuthor(`ØªÙ… ØªØ´ØºÙŠÙ„`, message.author.avatarURL)
						.setDescription(`**${videoInfo.title}**`)
						.setColor("RANDOM")
						.setFooter('ØªÙ… ØªØ´ØºÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ù‡: ' + message.author.tag)
						.setThumbnail(videoInfo.thumbnailUrl)
					//.setDescription('?')
					message.channel.sendEmbed(play_info);
				});
			});
		}
	}
	else if (mess.startsWith(prefix + 'skip')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		message.reply(':gear: **ØªÙ… ØªØ®Ø·ÙŠ Ø§ØºÙ†ÙŠÙ‡**').then(() => {
			skip_song(message);
			var server = server = servers[message.guild.id];
			if (message.guild.voiceConnection) message.guild.voiceConnection.end();
		});
	}
	else if (message.content.startsWith(prefix + 'vol')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		// console.log(args)
		if (args > 10) return message.reply(':x: **10**');
		if (args < 1) return message.reply(":x: **1**");
		dispatcher.setVolume(1 * args / 10);
		message.channel.sendMessage(`**${dispatcher.volume*10}** :ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØª Ø§Ù„ÙŠ  `);
	}
	else if (mess.startsWith(prefix + 'pause')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		message.reply(':gear: **ØªÙ… ØªÙˆÙ‚ÙŠÙ Ø¨ÙˆØª Ù…Ø¤Ù‚ØªØ§**').then(() => {
			dispatcher.pause();
		});
	}
	else if (mess.startsWith(prefix + 'unpause')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		message.reply(':gear: **ØªÙ… Ø§Ø¹Ø§Ø¯Ù‡ ØªØ´ØºÙŠÙ„ Ø§ØºÙ†ÙŠÙ‡**').then(() => {
			dispatcher.resume();
		});
	}
	else if (mess.startsWith(prefix + 'stop')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		message.reply(':name_badge: **ØªÙ… ØªÙˆÙ‚ÙŠÙ Ø§ØºÙ†ÙŠÙ‡**');
		var server = server = servers[message.guild.id];
		if (message.guild.voiceConnection) message.guild.voiceConnection.disconnect();
	}
	else if (mess.startsWith(prefix + 'join')) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		message.member.voiceChannel.join().then(message.react('âœ…'));
	}
	else if (mess.startsWith(prefix + 'play')) {
		getID(args, function(id) {
			add_to_queue(id);
			fetchVideoInfo(id, function(err, videoInfo) {
				if (err) throw new Error(err);
				if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
				if (isPlaying == false) return message.reply(':x:');
				let playing_now_info = new Discord.RichEmbed()
					.setAuthor(client.user.username, client.user.avatarURL)
					.setDescription(`**${videoInfo.title}**`)
					.setColor("RANDOM")
					.setFooter('Requested By:' + message.author.tag)
					.setImage(videoInfo.thumbnailUrl)
				message.channel.sendEmbed(playing_now_info);
				queueNames.push(videoInfo.title);
				// let now_playing = videoInfo.title;
				now_playing.push(videoInfo.title);

			});

		});
	}

	function skip_song(message) {
		if (!message.member.voiceChannel) return message.reply('**Ø¹Ø°Ø±Ø§ Ø§Ù†Øª Ù„Ø³Øª ÙÙŠ Ø±ÙˆÙ… Ø§Ù„Ø§ØºØ§Ù†ÙŠ**');
		dispatcher.end();
	}

	function playMusic(id, message) {
		voiceChannel = message.member.voiceChannel;


		voiceChannel.join().then(function(connectoin) {
			let stream = ytdl('https://www.youtube.com/watch?v=' + id, {
				filter: 'audioonly'
			});
			skipReq = 0;
			skippers = [];

			dispatcher = connectoin.playStream(stream);
			dispatcher.on('end', function() {
				skipReq = 0;
				skippers = [];
				queue.shift();
				queueNames.shift();
				if (queue.length === 0) {
					queue = [];
					queueNames = [];
					isPlaying = false;
				}
				else {
					setTimeout(function() {
						playMusic(queue[0], message);
					}, 500);
				}
			});
		});
	}

	function getID(str, cb) {
		if (isYoutube(str)) {
			cb(getYoutubeID(str));
		}
		else {
			search_video(str, function(id) {
				cb(id);
			});
		}
	}

	function add_to_queue(strID) {
		if (isYoutube(strID)) {
			queue.push(getYoutubeID(strID));
		}
		else {
			queue.push(strID);
		}
	}

	function search_video(query, cb) {
		request("https://www.googleapis.com/youtube/v3/search?part=id&type=video&q=" + encodeURIComponent(query) + "&key=" + yt_api_key, function(error, response, body) {
			var json = JSON.parse(body);
			cb(json.items[0].id.videoId);
		});
	}


	function isYoutube(str) {
		return str.toLowerCase().indexOf('youtube.com') > -1;
	}
});




client.on("message", message => { //help
          if(!message.channel.guild) return;
   if(message.author.bot) return;
      if(message.content === prefix + "help"){ 
          const embed = new Discord.RichEmbed()
      .setTimestamp()
      .setColor("#5016f3")
      .setThumbnail(client.user.avatarURL)
      .setDescription(` 
      ***__music orders__***
     
    ã€${prefix}play / Ù„ØªØ´ØºÙŠÙ„ Ø£ØºÙ†ÙŠØ© Ø¨Ø±Ø¢Ø¨Ø· Ø£Ùˆ Ø¨Ø£Ø³Ù…ã€
    ã€${prefix}skip / Ù„ØªØ¬Ø¢ÙˆØ² Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø§Ù„Ø­Ø¢Ù„ÙŠØ©ã€
    ã€${prefix}pause / Ø¥ÙŠÙ‚Ø¢Ù Ø§Ù„Ø£ØºÙ†ÙŠØ© Ù…Ø¤Ù‚ØªØ§ã€
    ã€${prefix}unpause / Ù„Ù…ÙˆØ¢ØµÙ„Ø© Ø§Ù„Ø¥ØºÙ†ÙŠØ© Ø¨Ø¹Ø¯ Ø¥ÙŠÙ‚Ø¢ÙÙ‡Ø¢ Ù…Ø¤Ù‚ØªØ§ã€
    ã€${prefix}vol / Ù„ØªØºÙŠÙŠØ± Ø¯Ø±Ø¬Ø© Ø§Ù„ØµÙˆØª 10 - 0ã€
    ã€${prefix}stop / Ù„Ø¥Ø®Ø±Ø¢Ø¬ Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ø§Ù„Ø±ÙˆÙ…ã€
      `)

 message.channel.send({embed});

}
});




client.on('message', message => {
    if(!message.channel.guild) return;
if (message.content.startsWith('$ping')) {
if(!message.channel.guild) return;
var msg = `${Date.now() - message.createdTimestamp}`
var api = `${Math.round(client.ping)}`
if (message.author.bot) return;
let embed = new Discord.RichEmbed()
.setAuthor(message.author.username,message.author.avatarURL)
.setColor('RANDOM')
.addField('**Time Taken:**',msg + " ms ğŸ“¶ ")
.addField('**WebSocket:**',api + " ms ğŸ“¶ ")
message.channel.send({embed:embed});
}
});







client.login(process.env.BOT_TOKEN);
